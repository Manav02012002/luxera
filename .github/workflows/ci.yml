name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  release-hardening:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Unit tests
        run: pytest -q -m "not slow and not radiance and not gui"

      - name: Release gates
        run: make release-check

      - name: Performance budgets
        run: make benchmark-check

      - name: Parity subset
        run: pytest -q tests/test_parity_packs.py -k "small_indoor or small_roadway"

      - name: Parity fast corpus gate
        run: luxera parity run --selector parity/ci/fast_selection.yaml --baseline luxera --out out/parity_ci

      - name: Parity invariance suite gate
        run: luxera parity run --pack invariance_suite --baseline luxera --out out/parity_invariance

      - name: Upload parity fast artifact
        uses: actions/upload-artifact@v4
        with:
          name: parity_ci
          path: out/parity_ci

      - name: Upload parity invariance artifact
        uses: actions/upload-artifact@v4
        with:
          name: parity_invariance
          path: out/parity_invariance
